#!/usr/bin/env bash
# Show description char usage per installed plugin
# Usage: plugin-breakdown

set -e

# Find this skill's directory
skill_dir="$(cd "$(dirname "$0")/.." && pwd)"
scan_skills="$skill_dir/bin/scan-skills"
scan_commands="$skill_dir/bin/scan-commands"
plugins_cache="$HOME/.claude/plugins/cache"

if [ ! -d "$plugins_cache" ]; then
  echo "No plugins installed."
  exit 0
fi

# Count chars from description: lines in listed files only
count_descriptions() {
  local chars=0
  while IFS='|' read -r path type name; do
    [ -z "$path" ] && continue
    line_chars=$(grep "^description:" "$path" 2>/dev/null | head -1 | wc -c | tr -d ' ')
    chars=$((chars + line_chars))
  done
  echo "$chars"
}

echo "Plugin Description Usage"
echo "========================"
echo ""
printf "%-50s %8s\n" "Plugin" "Chars"
printf "%-50s %8s\n" "------" "-----"

total=0

# Each marketplace is a subdirectory
for marketplace in "$plugins_cache"/*/; do
  [ -d "$marketplace" ] || continue
  marketplace_name=$(basename "$marketplace")

  # Each plugin is a subdirectory within marketplace
  for plugin in "$marketplace"/*/; do
    [ -d "$plugin" ] || continue
    plugin_name=$(basename "$plugin")

    # Find latest non-orphaned version
    latest=""
    for v in $(ls -1 "$plugin" | sort -t. -k1,1n -k2,2n -k3,3n); do
      [ -f "$plugin/$v/.orphaned_at" ] || latest="$v"
    done

    # Skip if all versions are orphaned (uninstalled)
    [ -n "$latest" ] || continue

    version_dir="$plugin/$latest"

    # Count only real skills and commands (not themes, examples, etc.)
    skills_chars=$("$scan_skills" "${version_dir}/skills" 2>/dev/null | count_descriptions)
    cmds_chars=$("$scan_commands" "${version_dir}/commands" 2>/dev/null | count_descriptions)
    chars=$((skills_chars + cmds_chars))

    if [ "$chars" -gt 0 ]; then
      total=$((total + chars))
      printf "%-50s %8d\n" "$plugin_name@$marketplace_name" "$chars"
    fi
  done
done

echo ""
printf "%-50s %8d\n" "TOTAL" "$total"
