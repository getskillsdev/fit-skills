#!/usr/bin/env bash
# Output JSON array of configured MCP servers
# Usage: all/mcp-items
#
# Output: JSON array with objects containing:
#   - name: server name (e.g., "playwright")
#   - type: "mcp"
#   - source: "project" or "global"
#   - plugin: null
#   - path: config file path
#   - disabled: true if disabled, null otherwise
#
# MCP Config Locations (3 scopes):
#   1. User config:    ~/.claude.json → mcpServers (available in all projects)
#   2. Project config: .mcp.json → mcpServers (shared via repo, checked into git)
#   3. Local config:   ~/.claude.json → projects[path].mcpServers (private to you)
#
# Disabled State (checked in ~/.claude.json at 2 levels × 2 fields = 4 places):
#   Global:  .disabledMcpServers, .disabledMcpjsonServers
#   Project: .projects[path].disabledMcpServers, .projects[path].disabledMcpjsonServers
#
# Note: .mcp.json only defines servers, disabled state is always in ~/.claude.json

set -e

# Find project root by walking up from PWD
check_dir="$PWD"
project_root=""
while [ "$check_dir" != "/" ]; do
  if [ -d "$check_dir/.claude" ] || [ -f "$check_dir/.mcp.json" ]; then
    project_root="$check_dir"
    break
  fi
  check_dir="$(dirname "$check_dir")"
done

# Get disabled servers from ~/.claude.json (all 4 places)
# Resolve symlinks to match how Claude stores project paths
disabled_servers=""
if [ -f "$HOME/.claude.json" ]; then
  resolved_root=""
  if [ -n "$project_root" ]; then
    resolved_root=$(readlink -f "$project_root" 2>/dev/null || echo "$project_root")
  fi

  # Collect from all 4 places into one list
  disabled_servers=$(jq -r --arg proj "$resolved_root" '
    [
      # Global level
      (.disabledMcpServers // []),
      (.disabledMcpjsonServers // []),
      # Project level (if path provided)
      (if $proj != "" then .projects[$proj].disabledMcpServers // [] else [] end),
      (if $proj != "" then .projects[$proj].disabledMcpjsonServers // [] else [] end)
    ] | flatten | unique | .[]
  ' "$HOME/.claude.json" 2>/dev/null || echo "")
fi

# Check if a server is disabled
is_disabled() {
  local name="$1"
  echo "$disabled_servers" | grep -qx "$name" 2>/dev/null
}

# Start JSON array
echo "["
first=true

# Extract server names from mcpServers object
extract_servers() {
  local file="$1"
  local source="$2"
  [ -f "$file" ] || return 0

  # Get keys from mcpServers object
  local servers
  servers=$(jq -r '.mcpServers // {} | keys[]' "$file" 2>/dev/null) || return 0

  while IFS= read -r name; do
    [ -z "$name" ] && continue
    [ "$first" = true ] && first=false || echo ","
    if is_disabled "$name"; then
      printf '  {"name": "%s", "type": "mcp", "source": "%s", "plugin": null, "path": "%s", "disabled": true}' "$name" "$source" "$file"
    else
      printf '  {"name": "%s", "type": "mcp", "source": "%s", "plugin": null, "path": "%s", "disabled": null}' "$name" "$source" "$file"
    fi
  done <<< "$servers"
}

# Project MCP config
if [ -n "$project_root" ] && [ -f "$project_root/.mcp.json" ]; then
  extract_servers "$project_root/.mcp.json" "project"
fi

# Global MCP config
if [ -f "$HOME/.claude.json" ]; then
  extract_servers "$HOME/.claude.json" "global"
fi

echo ""
echo "]"
