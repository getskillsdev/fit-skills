#!/usr/bin/env bash
# Output JSON array of configured MCP servers
# Usage: all/mcp-items
#
# Output: JSON array with objects containing:
#   - name: server name (e.g., "playwright")
#   - type: "mcp"
#   - source: "project" or "global"
#   - plugin: null
#   - path: config file path
#   - disabled: true if in disabledMcpServers, null otherwise

set -e

# Find project root by walking up from PWD
check_dir="$PWD"
project_root=""
while [ "$check_dir" != "/" ]; do
  if [ -d "$check_dir/.claude" ] || [ -f "$check_dir/.mcp.json" ]; then
    project_root="$check_dir"
    break
  fi
  check_dir="$(dirname "$check_dir")"
done

# Get disabled servers from ~/.claude.json for this project
disabled_servers=""
if [ -n "$project_root" ] && [ -f "$HOME/.claude.json" ]; then
  disabled_servers=$(jq -r ".projects[\"$project_root\"].disabledMcpServers // [] | .[]" "$HOME/.claude.json" 2>/dev/null || echo "")
fi

# Check if a server is disabled
is_disabled() {
  local name="$1"
  echo "$disabled_servers" | grep -qx "$name" 2>/dev/null
}

# Start JSON array
echo "["
first=true

# Extract server names from mcpServers object
extract_servers() {
  local file="$1"
  local source="$2"
  [ -f "$file" ] || return 0

  # Get keys from mcpServers object
  local servers
  servers=$(jq -r '.mcpServers // {} | keys[]' "$file" 2>/dev/null) || return 0

  while IFS= read -r name; do
    [ -z "$name" ] && continue
    [ "$first" = true ] && first=false || echo ","
    if is_disabled "$name"; then
      printf '  {"name": "%s", "type": "mcp", "source": "%s", "plugin": null, "path": "%s", "disabled": true}' "$name" "$source" "$file"
    else
      printf '  {"name": "%s", "type": "mcp", "source": "%s", "plugin": null, "path": "%s", "disabled": null}' "$name" "$source" "$file"
    fi
  done <<< "$servers"
}

# Project MCP config
if [ -n "$project_root" ] && [ -f "$project_root/.mcp.json" ]; then
  extract_servers "$project_root/.mcp.json" "project"
fi

# Global MCP config
if [ -f "$HOME/.claude.json" ]; then
  extract_servers "$HOME/.claude.json" "global"
fi

echo ""
echo "]"
