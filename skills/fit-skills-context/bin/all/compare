#!/usr/bin/env bash
# Compare two JSON inventory files (disk snapshot vs context snapshot)
# Usage: all/compare <disk-json> <context-json>
#
# Output:
#   - Items in disk but not in context (dropped due to token limits)
#   - Items in context but not on disk (MCP tools, etc.)

set -e

disk_file="${1:?Usage: all/compare <disk-json> <context-json>}"
context_file="${2:?Usage: all/compare <disk-json> <context-json>}"

if [ ! -f "$disk_file" ]; then
  echo "Error: File not found: $disk_file" >&2
  exit 1
fi

if [ ! -f "$context_file" ]; then
  echo "Error: File not found: $context_file" >&2
  exit 1
fi

tmp_dir=$(mktemp -d)
trap "rm -rf $tmp_dir" EXIT

# Get names from disk JSON
jq -r '[.[] | .name] | sort | .[]' "$disk_file" > "$tmp_dir/disk-names.txt"

# Get names from context JSON
jq -r '[.[] | .name] | sort | .[]' "$context_file" > "$tmp_dir/context-names.txt"

disk_count=$(wc -l < "$tmp_dir/disk-names.txt" | tr -d ' ')
context_count=$(wc -l < "$tmp_dir/context-names.txt" | tr -d ' ')

echo "=== COMPARISON ==="
echo ""
echo "On disk:    $disk_count items"
echo "In context: $context_count items"
echo ""

# Items on disk but not in context - split into INVALID vs DROPPED
invalid_output=""
dropped_output=""
while read -r name; do
  [ -z "$name" ] && continue

  # Get type for this item
  item_type=$(jq -r ".[] | select(.name == \"$name\") | .type" "$disk_file" | head -1)

  # For MCP servers, check if any mcp__{name}__* tools exist in context
  if [ "$item_type" = "mcp" ]; then
    if grep -q "^mcp__${name}__" "$tmp_dir/context-names.txt" 2>/dev/null; then
      # MCP server has tools loaded, not really dropped
      continue
    fi
  fi

  # Check if item has invalid field set
  invalid_msg=$(jq -r ".[] | select(.name == \"$name\") | .invalid // empty" "$disk_file" | head -1)

  # Get type:source for each occurrence (handles duplicates)
  info=$(jq -r ".[] | select(.name == \"$name\") | \"\(.type):\(.source)\"" "$disk_file" | sort -u | paste -sd, -)

  if [ -n "$invalid_msg" ] && [ "$invalid_msg" != "null" ]; then
    invalid_output="${invalid_output}- $name ($info) â€” $invalid_msg
"
  else
    dropped_output="${dropped_output}- $name ($info)
"
  fi
done < <(comm -23 "$tmp_dir/disk-names.txt" "$tmp_dir/context-names.txt")

echo "=== INVALID (not loadable by Claude Code) ==="
if [ -z "$invalid_output" ]; then
  echo "(none)"
else
  printf "%s" "$invalid_output"
fi
echo ""

echo "=== DROPPED (on disk but not in context) ==="
if [ -z "$dropped_output" ]; then
  echo "(none)"
else
  printf "%s" "$dropped_output"
fi
echo ""

# Items in context but not on disk (MCP tools, etc.)
echo "=== EXTERNAL (in context but not on disk) ==="
external=$(comm -13 "$tmp_dir/disk-names.txt" "$tmp_dir/context-names.txt")
if [ -z "$external" ]; then
  echo "(none)"
else
  echo "$external" | while read -r name; do
    # Get type for context
    type=$(jq -r ".[] | select(.name == \"$name\") | .type" "$context_file")
    echo "- $name ($type)"
  done
fi
